# Elasticsearch线上环境

## 内网服务器

- 服务器配置（连接方式TeamViewer）
  - 网站服务器1：
    - 账号:107021417
    - 密码：abc123
    - 锁屏密码: zqy1995
    - root密码:abc123
  - 网站服务器2(数据库所在服务器)：
    - 账号：735586570
    - 密码：191155395
    - mongodb: port 37215 admin abc123?


## 公网服务器

- 用作端口转发以实现内网穿透的公网服务器

  - ssh root@139.199.183.196 liu15171513459
  - mysql root liu612921

- 学校给的存数据的服务器
  - 121.49.110.62:22
  - zqy 191155395
  - mongo root: admin abc123?

## 服务器环境配置

- nginx
- node(泽章采用nvm配置)
- php7.0

# 内网穿透

- [参考博客](https://blog.csdn.net/lidongshengajz/article/details/73482908?tdsourcetag=s_pctim_aiomsg)

### 建立ssh隧道

- ```
  ssh -p 22 -qngfNTR 6766:127.0.0.1:22 root@139.199.183.196
  ssh -p 22 -qngfNTR 6769:127.0.0.1:80 root@139.199.183.196
  ```

  - 作用：在内网机器上执行这条指令，建立一个反向隧道，将外网机器（139.199.183.196）的6766端口转发到内网机器的22端口上，只要这条隧道不关闭，这个转发会始终有效，有个这个端口转发，只需要访问外网机器的6766端口即可反向连接至B。
- 参数：
  - -p:指定远程主机的端口
  - -q:安静模式，消除所有的警告和诊断信息
  - -n:把 stdin 重定向到 /dev/null (实际上防止从 stdin 读取数据). 在后台运行时一定会用到这个选项.
  - -g:允许远端主机连接本机转发的端口
  - -f:要求 在执行命令前退至后台. 它用于当 准备询问口令或密语, 但是用户希望它在后台进行.  该选项隐含了 -n 选项. 
  - -N:不执行远程指令，用于转发端口
  - -T：意思是说禁止分配伪终端。当用ssh或telnet等登录系统时，系统分配给我们的终端就是伪终端。
    如果ssh使用此选项登录系统时，由于禁用，将无法获得终端；但仍能够获得shell，只不过看起来像在本地，也没有很多应有的环境变量，例如命令提示符，PS1等。可以降低资源消耗
  - -R port:host:port：将远程主机（服务器）的某个端口转发到本地端指定机器的指定端口。

### 在外网机器上配置/etc/sshd_config

```
GatewayPorts yes
```

- 作用：允许其他主机访问本机的转发端口

### 删除ssh连接

- ```shell
  ps -eo pid,args | grep ssh
  kill -9 $pid
  ```

- 作用：展示所有进程的pid和args,找到ssh的进程，用kill结束它

### 保持连接的稳定性

- ```
  autossh -p 22 -M 7023 -NR 7022:127.0.0.1:22 root@139.199.183.196
  autossh -p 22 -M 7081 -NR 7080:127.0.0.1:80 root@139.199.183.196
  ```


### 其他

- ```shell
  netstat -nat
  ```
  - 参数：
    - -a(all):显示所有选项，默认不显示LISTEN相关
    - -n:拒绝显示别名，能显示数字的全部转化成数字
    - -t:仅显示tcp相关选项。

- ```shell
  service sshd restart
  ```

  - 作用：修改了sshd的配置文件（这里用于开启gateway以允许其他机器访问本机的端口转发功能）之后重启ssh

# 安全性

- 目前，通过公网转发的端口有：22 80 9200 5601 443
- kibana设置为所有ip可以访问
  - 设置elasticsearch的bindip为0.0.0.0时出现报错，服务起不来