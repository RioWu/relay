# 服务器迁移步骤

1.安装mysql、nginx、php

- 建议使用包管理器安装，这样比较便于管理
- [参考博客](https://www.jianshu.com/p/afbbac65fa3e)

2.安装git

- `sudo apt-get install git`

- 使用`git clone`命令将项目代码克隆到网站目录下
  - 前端仓库地址:`http://git.stuhome.com/leere/southeast-asia-news.git`
  - 后端仓库地址:`http://git.stuhome.com/RioChen/southeast_news_backend.git`
  - 使用方式:`git clone 仓库地址`
- 修改后端仓库项目`connect.php`文件，修改数据库用户名和密码，改成之前安装mysql时设置的用户名和密码

3.mysql数据导入

- `create database southeast_news;`
- `source ....../southeast_news.sql`（southeast_news.sql是项目需要的sql文件，这个文件可以在后端仓库代码里找到，`......`表示该文件的路径

4.elasticsearch相关

- [安装elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html)

- 启动命令：`./bin/elasticsearch -d -p pid`

- elasticsearch配置（如果按照上面的方式安装elasticsearch，elasticsearch的配置文件路径在`/etc/elasticsearch/`）
  - 去elasticsearch.yml里设置允许外网访问,然后`service elasticsearch restart`
    - `/etc/elasticsearch/elasticsearch.yml`
      - network.host: 0.0.0.0

  - 因为是单节点，不用配置clustername等一系列的内容，只需要在`/etc/elasticsearch/jvm.option`里配置下jvm内存即可，这里简单的介绍一下这个内存该如何配置

    - elasticsearch对于内存的使用总的来看分为两部分：jvm对内存的使用和elasticsearch对内存的使用，前者是指执行搜索时，这个程序能调用的内存大小，一般建议最高32G，后者不用自己配置，但是会影响搜索速度，因为elasticsearch会把经常搜索的内容放入内存中作为cache，极大的增加搜索速度

  - 配置时遇到的问题及解决

    - 遇到了多个elasticsear版本安装在同一个系统上的情况，报错代码如下：

      ```
      elasticsearch 6.4.2-1 installations fails on Fedora 28 with "Exception in thread "main" java.lang.NoSuchMethodError: org.elasticsearch.cli.Command.<init>(Ljava/lang/String;)
      ```

    - [参考博客](https://github.com/elastic/elasticsearch/issues/34281)

  - 无法以root用户运行elasticsearch，报错代码如下：

    ```
    [WARN ][o.e.b.ElasticsearchUncaughtExceptionHandler] [] uncaught exception in thread [main]org.elasticsearch.bootstrap.StartupException: java.lang.RuntimeException: can not run elasticsearch as root
    ```

    - 创建新用户，并且更改elasticsearch的所属组别以及所属用户
    - [参考博客](https://www.imooc.com/article/22708)

- elasticsearch数据库迁移（在两个elasticsearch服务器之间）

  - 找到了可以一次性传输所有数据的办法，使用elasticsearch官方的数据迁移工具logstash

    - [安装logstash](https://www.elastic.co/guide/en/logstash/current/installing-logstash.html#package-repositories)

    - 配置logstash的配置文件 xxx.conf

      ```
      input {
          elasticsearch {
              hosts => ["http://121.48.165.39:9200"]
              index => "*"
              docinfo => true
              scroll => "1m"
              codec => "json"
          }
      }
      output {
          elasticsearch {
              hosts => ["http://121.48.165.38:9200"]
              index => "%{[@metadata][_index]}"
          }
          stdout { codec => rubydebug { metadata => true } }
      }
      ```

    - 执行命令`logstash -f xxx.conf  `，然后数据就会在两个elasticsearch的服务器上同步了

  # MongoDB和Elasticsearch同步

  注：不管是哪种方式，要进行同步都要开启mongodb的副本集模式，

  关于副本集模式：

  - [参考博客](https://www.cnblogs.com/ljhdo/p/4583276.html)
  - [官方文档](https://docs.mongodb.com/manual/tutorial/deploy-replica-set/)
  - 说明：因为副本集模式主要针对mongodb集群而言，单机开启副本集并不能达到高可用、高容错的功能，只是添加了一个oplog，但我们使用这个oplog去完成mongodb和elasticsearch的同步

  ## MongoDB副本集开启过程

  - `mongod -f /etc/mongod.conf --fork --replSet "rs0"`
  - 使用`mongo`命令连接至mongo
  - 使用`rs.initiate()`初始化副本集

  ## 使用工具mongo-es

  - [github地址](https://github.com/jike-engineering/mongo-es)

  - 简单使用步骤：

    - 使用`npm`安装mongo-es，根据需要写好配置文件`config.json`（具体写法见github，有详细解释）

    - 我之前写的如下：

      ```json
      {
          "controls": {
              "mongodbReadCapacity": 1000,
              "elasticsearchBulkSize": 1000,
              "elasticsearchBulkInterval": 200,
              "indexNameSuffix": ""
          },
          "mongodb": {
              "url": "mongodb://121.48.165.38:27017"
          },
          "elasticsearch": {
              "options": {
                  "host": "http://localhost:9200",
                  "apiVersion": "5.x"
              },
              "indices": [
                  {
                      "index": "indonesia_antara",
                      "body": {
                          "settings": {
                              "index": {
                                  "number_of_shards": 3,
                                  "number_of_replicas": 1,
                                  "mapper.dynamic": false
                              }
                          }
                      }
                  }
              ]
          },
          "tasks": [
              {
                  "from": {
                      "phase": "scan"
                  },
                  "extract": {
                      "db": "indonesia",
                      "collection": "antara"
                  },
                  "transform": {
                      "mapping": {
                          "author": "author",
                          "url": "url",
                          "media": "media",
                          "abstract": "abstract",
                          "site": "site",
                          "news_title": "news_title",
                          "public_date": "public_date",
                          "news_content": "news_content",
                          "type": "type"
                      }
                  },
                  "load": {
                      "index": "indonesia_antara",
                      "type": "news_data",
                      "body": {
                          "dynamic": false,
                          "properties": {
                              "author": {
                                  "type": "text"
                              },
                              "url": {
                                  "type": "text"
                              },
                              "media": {
                                  "type": "text"
                              },
                              "abstract": {
                                  "type": "text"
                              },
                              "site": {
                                  "type": "text"
                              },
                              "news_title": {
                                  "type": "text"
                              },
                              "public_date": {
                                  "type": "date"
                              },
                              "news_content": {
                                  "type": "text"
                              },
                              "type": {
                                  "type": "keyword"
                              }
                          }
                      }
                  }
              }
          ]
      }
      ```

      

    - 执行命令`mongo-es config.json`

  ## 使用工具mongo-connector

  - [github地址](https://github.com/yougov/mongo-connector)

  - [参考博客](https://blog.csdn.net/laoyang360/article/details/51842822)

  - 踩过的几个坑：

    - `ServerSelectionTimeoutError: Could not reach any servers in [('amax', 27017)]. Replica set is configured with internal hostnames or IPs`

      - 解决方法：在开启副本集的那个服务器上设置一下副本集的配置，因为mongo-connector会读取副本集的配置，在配置里要找到host属性，再根据这个属性去找到对应的服务器和端口连接mongodb服务器，如果找不到，就会报这个错

        ```
        cfg = rs.conf()
        cfg.members[0].host = "ipaddress:27017"		//ipaddress指本季ip地址
        rs.reconfig(cfg)
        ```

    - mongo-connector 不支持 elasticsearch6.x，所以要把elasticsearch降级

    - mongo-connector在使用的时候要选择`doc-manager`，注意，elasticsearch2.x以及以上版本用的都是`elastic2-doc-manager`，当时找了半天没找elasticsearch5.x用的`doc-manager`叫什么。。。。

    - 调用命令：` mongo-connector -m 121.48.165.38:27017 -t 121.48.165.39:9200 -d elastic2_doc_manager`

## 使用screen工具

- `screen -S screen_name`：新建一个名叫`screen_name`的session
- `screen -ls`：列出当前所有的session
- `screen -r screen_name`：回到`screen_name`这个session
  - 在screen session里，使用`control + a + d`可以暂时离开当前session，将目前的screen session 丢到后台执行

